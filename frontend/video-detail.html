<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Video Detail</title>
<link rel="stylesheet" href="tailwind.css">
</head>

<body>

<div class="max-w-6xl mx-auto mt-8">

  <!-- VIDEO PLAYER -->
  <div class="bg-black rounded-xl overflow-hidden">
    <video id="videoPlayer"
      controls
      class="w-full h-[500px] object-contain">
    </video>
  </div>

  <!-- VIDEO INFO -->
  <div class="mt-6">

    <h1 id="videoTitle"
      class="text-2xl font-bold mb-4">
    </h1>

    <!-- CREATOR -->
    <div class="flex items-center justify-between">

      <div class="flex items-center gap-4">

        <img id="creatorAvatar"
          class="w-12 h-12 rounded-full"/>

        <div>
          <p id="creatorName"
             class="font-semibold"></p>
        </div>

      </div>

      <!-- ACTION -->
      <div class="flex items-center gap-3">

        <!-- üîî Notification -->
        <button id="notifyBtn"
          class="p-3 rounded-full bg-gray-100 hover:bg-gray-200">
          üîî
        </button>

        <!-- FOLLOW -->
        <button id="followBtn"
          class="px-5 py-2 bg-blue-500 text-white rounded-full">
          Follow
        </button>

      </div>

    </div>

  </div>

</div>

<!-- ================= POPUP LOCK ================= -->

<div id="unlockPopup"
 class="hidden fixed inset-0 bg-black/60
 flex items-center justify-center">

  <div class="bg-white p-6 rounded-xl w-[350px]">

    <h2 class="text-lg font-bold mb-3">
      üîí Video b·ªã kh√≥a
    </h2>

    <p id="unlockText"
       class="mb-4 text-gray-600">
    </p>

    <button id="unlockBtn"
      class="w-full bg-blue-500 text-white py-2 rounded-lg">
      M·ªü kh√≥a
    </button>

  </div>

</div>

<script>
  const token = localStorage.getItem('token');
  if (!token) {
    window.location.href = 'login.html';
  }

  const urlParams = new URLSearchParams(window.location.search);
  const videoId = urlParams.get('id');
  let following = false;

  async function loadVideo(){
    try {
      const res = await fetch(`/api/video/${videoId}/`, {
        headers: {
          Authorization: `Bearer ${token}`
        }
      });

      const data = await res.json();

      if (!res.ok) {
        alert(data.message || 'Kh√¥ng t·∫£i ƒë∆∞·ª£c video.');
        return;
      }

      document.getElementById("videoTitle").innerText = data.title;
      document.getElementById("creatorName").innerText = data.creator.name;
      document.getElementById("creatorAvatar").src = data.creator.avatar;

      following = data.following;
      setupFollow(data.creator.id);
      setupNotify();

      if(data.locked){
        document.getElementById("unlockPopup").classList.remove("hidden");
        document.getElementById("unlockText").innerText = `B·∫°n c·∫ßn ${data.requiredTC} TC ƒë·ªÉ m·ªü kh√≥a`;
      } else {
        document.getElementById("videoPlayer").src = data.videoUrl;
      }
    } catch (err) {
      alert('Kh√¥ng t·∫£i ƒë∆∞·ª£c video.');
    }
  }

  function setupFollow(creatorId){
    const btn = document.getElementById("followBtn");

    const updateBtn = () => {
      btn.innerText = following ? "Following" : "Follow";
      btn.className = following
        ? "px-5 py-2 bg-gray-300 rounded-full"
        : "px-5 py-2 bg-blue-500 text-white rounded-full";
    };

    updateBtn();

    btn.onclick = async ()=>{
      await fetch(`/api/follow/${creatorId}`,{
        method:"POST",
        headers:{ Authorization:`Bearer ${token}` }
      });

      following = !following;
      updateBtn();
    };
  }

  function setupNotify(){
    document.getElementById("notifyBtn").onclick = async ()=>{
      await fetch(`/api/creator/notify-toggle`,{
        method:"POST",
        headers:{ Authorization:`Bearer ${token}` }
      });
      alert("ƒê√£ b·∫≠t th√¥ng b√°o Creator üîî");
    };
  }

  async function unlockVideo(){
    try {
      const res = await fetch(
        `/api/video/${videoId}/unlock`,
        {
          method:"POST",
          headers:{ Authorization:`Bearer ${token}` }
        }
      );

      const data = await res.json();

      if(res.ok){
        document.getElementById("unlockPopup").classList.add("hidden");
        document.getElementById("videoPlayer").src = data.videoUrl;
      }else{
        alert(data.message || 'M·ªü kh√≥a th·∫•t b·∫°i');
      }
    } catch (err) {
      alert('M·ªü kh√≥a th·∫•t b·∫°i');
    }
  }

  document.getElementById('unlockBtn').addEventListener('click', unlockVideo);
  loadVideo();
</script>

</body>
</html>