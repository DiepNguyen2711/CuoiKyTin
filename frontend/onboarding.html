<!DOCTYPE html>
<html>
<head>
  <title>Onboarding</title>
  <link rel="stylesheet" href="tailwind.css">
</head>
<body>
<div class="progress-container">
  <div id="progressBar" class="progress-bar"></div>
</div>
<div class="auth-container">
  <div class="auth-card">
    <h2>Báº¡n lÃ  ai?</h2>

    <select id="role" class="auth-input-group" onchange="selectRole()">
      <option value="student">Há»c sinh / Sinh viÃªn</option>
      <option value="lecturer">Giáº£ng viÃªn</option>
      <option value="researcher">NhÃ  nghiÃªn cá»©u</option>
    </select>

    <div id="userStoryBox" style="margin-top:20px;"></div>
    <div id="surveyBox"></div>
  </div>
</div>

<script>
// HÃ m há»— trá»£ tá»± Ä‘á»™ng láº¥y CSRF Token tá»« Cookie cá»§a trÃ¬nh duyá»‡t
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

const csrftoken = getCookie('csrftoken');

// Kiá»ƒm tra email (náº¿u váº«n cáº§n dÃ¹ng email lÆ°u táº¡m á»Ÿ localStorage tá»« lÃºc Ä‘Äƒng kÃ½/Ä‘Äƒng nháº­p)
const email = localStorage.getItem("email");
if (!email) {
  alert("Báº¡n cáº§n Ä‘Äƒng nháº­p trÆ°á»›c!");
  window.location.href = "login.html";
}

function selectRole() {
  const role = document.getElementById("role").value;
  document.getElementById("progressBar").style.width = "40%";
  
  fetch("/api/select-role", {
    method: "POST",
    headers: { 
        "Content-Type": "application/json",
        "X-CSRFToken": csrftoken  // ğŸ‘‰ ÄÃ­nh kÃ¨m tháº» báº£o vá»‡ cá»§a Django
    },
    body: JSON.stringify({ email, role }),
  });

  renderUserStory(role);
  renderSurvey(role);
}

function renderUserStory(role) {
  const box = document.getElementById("userStoryBox");
  let story = "";

  if (role === "student") {
    story = `
    <p><strong>User Story:</strong><br>
    LÃ  má»™t há»c sinh/sinh viÃªn, tÃ´i muá»‘n cÃ³ má»™t lá»™ trÃ¬nh há»c táº­p cÃ¡ nhÃ¢n hÃ³a Ä‘á»ƒ cÃ³ thá»ƒ tÄƒng thu nháº­p vÃ  cÆ¡ há»™i nghá» nghiá»‡p.</p>`;
  }

  if (role === "lecturer") {
    story = `
    <p><strong>User Story:</strong><br>
    Vá»›i tÆ° cÃ¡ch lÃ  giáº£ng viÃªn, tÃ´i muá»‘n táº¡o ra nhá»¯ng khÃ³a há»c cÃ³ sá»©c áº£nh hÆ°á»Ÿng lá»›n Ä‘á»ƒ thu hÃºt thÃªm sinh viÃªn vÃ  tÄƒng thu nháº­p.</p>`;
  }
  
  if (role === "researcher") {
    story = `
    <p><strong>User Story:</strong><br>
    LÃ  má»™t nhÃ  nghiÃªn cá»©u, tÃ´i muá»‘n cÃ³ má»™t cÃ´ng cá»¥ AI há»— trá»£ Ä‘á»ƒ tÄƒng tá»‘c quÃ¡ trÃ¬nh nghiÃªn cá»©u vÃ  Ä‘áº¡t Ä‘Æ°á»£c nhiá»u cÃ´ng bá»‘ khoa há»c hÆ¡n.</p>`;
  }

  box.innerHTML = story;
}

function renderSurvey(role) {
  const box = document.getElementById("surveyBox");
  document.getElementById("progressBar").style.width = "40%";
  let questions = [];

  if (role === "student") {
    questions = [
      "Báº¡n muá»‘n tÄƒng thu nháº­p bao nhiÃªu % sau khÃ³a há»c?",
      "Báº¡n muá»‘n Ä‘áº¡t vá»‹ trÃ­ cÃ´ng viá»‡c nÃ o?",
      "Báº¡n cÃ³ cáº§n chá»©ng chá»‰ quá»‘c táº¿ khÃ´ng?",
      "Báº¡n cÃ³ bao nhiÃªu giá»/tuáº§n Ä‘á»ƒ Ä‘áº§u tÆ° cho viá»‡c há»c?"
    ];
  }

  if (role === "lecturer") {
    questions = [
      "Báº¡n muá»‘n tÄƒng bao nhiÃªu há»c viÃªn trong 6 thÃ¡ng?",
      "Báº¡n cÃ³ muá»‘n má»Ÿ khÃ³a há»c tráº£ phÃ­ khÃ´ng?",
      "Báº¡n muá»‘n xÃ¢y dá»±ng thÆ°Æ¡ng hiá»‡u cÃ¡ nhÃ¢n máº¡nh Ä‘áº¿n má»©c nÃ o?",
      "Báº¡n gáº·p khÃ³ khÄƒn gÃ¬ khi dáº¡y online?"
    ];
  }
  
  if (role === "researcher") {
    questions = [
      "Báº¡n Ä‘ang nghiÃªn cá»©u lÄ©nh vá»±c nÃ o?",
      "Báº¡n cáº§n AI há»— trá»£ á»Ÿ má»©c Ä‘á»™ nÃ o?",
      "Má»¥c tiÃªu cÃ´ng bá»‘ khoa há»c cá»§a báº¡n?",
      "Báº¡n dÃ nh bao nhiÃªu giá»/tuáº§n cho nghiÃªn cá»©u?"
    ];
  }

  box.innerHTML = "";

  questions.forEach((q, index) => {
    box.innerHTML += `
      <div class="auth-input-group">
        <label>${q}</label>
        <input type="text" id="q${index}">
      </div>
    `;
  });

  box.innerHTML += `
    <button class="auth-button" onclick="submitSurvey()">HoÃ n táº¥t</button>
  `;
}

async function submitSurvey() {
  const inputs = document.querySelectorAll("#surveyBox input");
  document.getElementById("progressBar").style.width = "100%";
  
  let answers = [];
  inputs.forEach(input => answers.push(input.value));

  // Gá»­i API kháº£o sÃ¡t
  await fetch("/api/survey", {
    method: "POST",
    headers: { 
        "Content-Type": "application/json",
        "X-CSRFToken": csrftoken // ğŸ‘‰ ÄÃ­nh kÃ¨m tháº» báº£o vá»‡ cá»§a Django
    },
    body: JSON.stringify({ email, answers }),
  });

  // Do Django Ä‘Ã£ dÃ¹ng Session Cookie, chá»‰ cáº§n chuyá»ƒn tháº³ng user vá» trang chá»§!
  alert("Cáº­p nháº­t há»“ sÆ¡ thÃ nh cÃ´ng!");
  window.location.href = "/";
}

</script>

</body>
</html>