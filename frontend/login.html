{% load static %}
<!doctype html>
<html>
  <head>
    <title>Đăng nhập - HourSkill</title>
    <link rel="stylesheet" href="{% static 'tailwind.css' %}" />
    <style>
      /* Ẩn con mắt mặc định của trình duyệt */
      input::-ms-reveal, input::-ms-clear { display: none; }
      
      .relative { position: relative; }
      .absolute { position: absolute; }
      .eye-icon { cursor: pointer; color: #6b7280; display: flex; align-items: center; }
      .eye-icon:hover { color: #3b82f6; }
      
      /* Thêm style cho nút khi đang load */
      .btn-loading {
          opacity: 0.7;
          cursor: not-allowed;
      }
    </style>
  </head>
  <body>
    <div class="auth-container">
      <div class="auth-card">
        <h2>Đăng nhập</h2>

        <div class="auth-input-group">
          <label>Email</label>
          <input type="email" id="email" placeholder="email@example.com" onkeypress="handleEnter(event)" />
        </div>

        <div class="auth-input-group">
          <label>Mật khẩu</label>
          <div class="relative">
            <input type="password" id="password" style="width: 100%; padding-right: 40px;" placeholder="Nhập mật khẩu" onkeypress="handleEnter(event)" />
            
            <span class="eye-icon absolute" style="right: 10px; top: 50%; transform: translateY(-50%);" onclick="togglePassword('password')">
              <svg id="eye-icon-password" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 20px; height: 20px;">
                <path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 0 1 0-.644C3.483 8.61 6.746 6.333 10 6.333s6.517 2.277 7.964 5.345a1.012 1.012 0 0 1 0 .644C16.517 15.39 13.254 17.667 10 17.667s-6.517-2.277-7.964-5.345Z" />
                <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
              </svg>
            </span>
          </div>
        </div>

        <button id="loginBtn" class="auth-button" onclick="login()">Đăng nhập</button>

        <div class="auth-footer">
          Chưa có tài khoản? <a href="{% url 'register' %}">Đăng ký</a>
        </div>
      </div>
    </div>

    <script>
      // 1. Hàm ẩn/hiện mật khẩu
      function togglePassword(inputId) {
        const input = document.getElementById(inputId);
        const icon = document.getElementById('eye-icon-' + inputId);
        if (input.type === "password") {
          input.type = "text";
          icon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" d="M3.98 8.223A10.477 10.477 0 0 0 1.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.451 10.451 0 0 1 12 4.5c4.756 0 8.773 3.162 10.065 7.498a10.522 10.522 0 0 1-4.293 5.774M6.228 6.228 3 3m3.228 3.228 3.65 3.65m7.894 7.894L21 21m-3.228-3.228-3.65-3.65m0 0a3 3 0 1 0-4.243-4.243m4.242 4.242L9.88 9.88" />`;
        } else {
          input.type = "password";
          icon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 0 1 0-.644C3.483 8.61 6.746 6.333 10 6.333s6.517 2.277 7.964 5.345a1.012 1.012 0 0 1 0 .644C16.517 15.39 13.254 17.667 10 17.667s-6.517-2.277-7.964-5.345Z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />`;
        }
      }

      // 2. Hàm bắt sự kiện nhấn phím Enter
      function handleEnter(event) {
        if (event.key === "Enter") {
          login(); // Gọi hàm đăng nhập khi nhấn Enter
        }
      }

      // 3. Hàm xử lý đăng nhập có hiệu ứng Loading
      async function login() {
        const email = document.getElementById("email").value;
        const password = document.getElementById("password").value;
        const btn = document.getElementById("loginBtn");

        // Bật hiệu ứng Loading
        btn.innerText = "Đang đăng nhập...";
        btn.disabled = true;
        btn.classList.add("btn-loading");

        try {
          const res = await fetch("/api/login/", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email, password }),
          });

          const data = await res.json();

          if (res.ok) {
            // Thành công thì nhảy trang (không cần tắt loading vì đằng nào cũng chuyển trang)
            window.location.href = "/main/"; 
          } else {
            // Thất bại thì báo lỗi và trả lại nút như cũ
            alert(data.message);
            btn.innerText = "Đăng nhập";
            btn.disabled = false;
            btn.classList.remove("btn-loading");
          }
        } catch (err) {
          alert("Lỗi kết nối server!");
          btn.innerText = "Đăng nhập";
          btn.disabled = false;
          btn.classList.remove("btn-loading");
        }
      }
    </script>
  </body>
</html>